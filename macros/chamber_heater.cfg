# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.


#####
# CHAMBER HEATER CONFIGURATION
####
[gcode_macro RatOS]
variable_chamber_heater_enable: True                     # True|False = enable chamber heater control
variable_chamber_heater_type: "generic_heater"           # generic_heater|output_pin|hotend = type of heater control
variable_chamber_heater_temperature: 150                 # int = this is not the target chamber temp, its the temp the heater is set to when heating the chamber


#####
# CHAMBER HEATER CONTROL MACROS
####
[gcode_macro _CHAMBER_HEATER_ON]
gcode:
	# parameter
	{% set bed_temp = params.BED_TEMP|default(0)|int %}
	{% set chamber_temp = params.CHAMBER_TEMP|default(0)|int %}
	{% set start_chamber_temp = params.START_CHAMBER_TEMP|default(0)|int %}

	# config
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set chamber_heater_enable = true if printer["gcode_macro RatOS"].chamber_heater_enable|default(true)|lower == 'true' else false %}
	{% set chamber_heater_type = printer["gcode_macro RatOS"].chamber_heater_enable|default("hotend")|lower %}
	{% set chamber_heater_temperature = printer["gcode_macro RatOS"].chamber_heater_temperature|default(150)|int %}

	DEBUG_ECHO PREFIX="_CHAMBER_HEATER_ON" MSG="chamber_heater_enable: {chamber_heater_enable}, chamber_heater_type: {chamber_heater_type}, chamber_heater_temperature: {chamber_heater_temperature}, bed_temp: {bed_temp}, chamber_temp: {chamber_temp}, start_chamber_temp: {start_chamber_temp}"

	# activate chamber heater on
	{% if chamber_heater_enable and chamber_temp > 0 and bed_temp > 0 %}

		# visual feedback
		_LED_HEATING

		RATOS_ECHO MSG="Heating chamber..."
		M140 S{bed_temp}
		G0 Z{z} F{z_speed}
		M84

		# wait until the hotend reaches the chamber temp
		{% if chamber_heater_type == "hotend" %}
			TEMPERATURE_WAIT SENSOR=extruder MINIMUM={(start_chamber_temp if start_chamber_temp > 0 else chamber_temp)}

		# activate the chamber heater and wait for the chamber target temperature. 
		{% elif chamber_heater_type == "generic_heater" %}
			{% if printer["temperature_sensor chamber"] is defined and printer["heater_generic chamber_heater"] is defined and printer["heater_fan chamber_heater_fan"] is defined %}
				SET_HEATER_TEMPERATURE HEATER=chamber_heater TARGET={chamber_heater_temperature}
				TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={(start_chamber_temp if start_chamber_temp > 0 else chamber_temp)}
				SET_HEATER_TEMPERATURE HEATER=chamber_heater TARGET={chamber_temp}
			{% endif %}

		# activate the output pin for external heating solutions with integrated temperature control
		{% elif chamber_heater_type == "output_pin" %}
			{% if printer["output_pin chamber_heater_pin"] is defined %}
				SET_PIN PIN=chamber_heater_pin VALUE=1.0
			{% endif %}

		{% endif %}

		MAYBE_HOME

	{% endif %}


[gcode_macro _CHAMBER_HEATER_OFF]
gcode:
	# config
	{% set chamber_heater_enable = true if printer["gcode_macro RatOS"].chamber_heater_enable|default(true)|lower == 'true' else false %}
	{% set chamber_heater_type = printer["gcode_macro RatOS"].chamber_heater_enable|default("hotend")|lower %}

	DEBUG_ECHO PREFIX="_CHAMBER_HEATER_OFF" MSG="chamber_heater_enable: {chamber_heater_enable}, chamber_heater_type: {chamber_heater_type}"

	# deactivate chamber heater
	{% if chamber_heater_enable %}

		RATOS_ECHO MSG="Deactivating chamber heater..."

		# deactivate chamber heater
		{% if chamber_heater_type == "generic_heater" %}
			{% if printer["temperature_sensor chamber"] is defined and printer["heater_generic chamber_heater"] is defined and printer["heater_fan chamber_heater_fan"] is defined %}
				SET_HEATER_TEMPERATURE HEATER=chamber_heater TARGET=0
			{% endif %}

		# deactivate the output pin for external heating solutions with integrated temperature control
		{% elif chamber_heater_type == "output_pin" %}
			{% if printer["output_pin chamber_heater_pin"] is defined %}
				SET_PIN PIN=chamber_heater_pin VALUE=0.0
			{% endif %}

		{% endif %}

	{% endif %}


