# WARNING: DO NOT EDIT THIS FILE
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

#####
# UNLOAD FILAMENT ENTRY POINTS
#####
[gcode_macro UNLOAD_FILAMENT]
description: Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode:
	{% set temp = params.TEMP|default(220)|int %}
	{% if printer["dual_carriage"] is not defined %}
		{% if printer["rmmu RMMU_T0"] is defined %}
			{% set toolhead = params.TOOLHEAD|default(-1)|int %}
			{% if toolhead < printer["rmmu RMMU_T0"].tool_count %}
				_DEFAULT_UNLOAD_FILAMENT TEMP={temp} TOOLHEAD={toolhead}
			{% else %}
				RATOS_ECHO MSG="Please select correct toolhead!"
			{% endif %}
		{% else %}
			_DEFAULT_UNLOAD_FILAMENT TEMP={temp} TOOLHEAD=0
		{% endif %}
	{% else %}
		{% if not printer.pause_resume.is_paused %}
			{% set toolhead = params.TOOLHEAD|default(-1)|int %}
		{% else %}
			{% set current_idex_mode = printer["dual_carriage"].carriage_1|lower %}
			{% if current_idex_mode == 'copy' or current_idex_mode == 'mirror' %}
				{action_raise_error("Unloading filament in Copy or Mirror mode is not supported! Select single mode to proceed.")}
			{% else %}
				{% set paused_idex_mode = printer["gcode_macro PAUSE"].idex_mode|lower %}
				{% if paused_idex_mode == 'copy' or paused_idex_mode == 'mirror' %}
					{% set toolhead = params.TOOLHEAD|default(-1)|int %}
				{% else %}
					{% set toolhead = printer["gcode_macro PAUSE"].idex_toolhead|int %}
				{% endif %}
			{% endif %}
		{% endif %}
		{% if printer["rmmu_hub"] is defined %}
			{% set physical_toolhead = printer["rmmu_hub"].mapping["%s" % toolhead]["TOOLHEAD"]|int %}
			_IDEX_UNLOAD_FILAMENT TEMP={temp} TOOLHEAD={physical_toolhead} FILAMENT={toolhead}
		{% else %}
			{% if toolhead==0 or toolhead==1 %}
				_IDEX_UNLOAD_FILAMENT TEMP={temp} TOOLHEAD={toolhead}
			{% else %}
				RATOS_ECHO MSG="Please select toolhead! 0 = left, 1 = right toolhead"
			{% endif %}
		{% endif %}
	{% endif %}


[gcode_macro _DEFAULT_UNLOAD_FILAMENT]
description: Unload filament macro for non IDEX printers.
gcode:
	# parameter
	{% set temp = params.TEMP|default(220)|int %}
	{% set toolhead = params.TOOLHEAD|int %}
	{% if printer["rmmu RMMU_T0"] is defined and toolhead == -1 %}
		{% if printer["rmmu RMMU_T0"].loaded_filament|int != -1 %}
			RATOS_ECHO PREFIX="RMMU_T0" MSG='Unloading filament T{printer["rmmu RMMU_T0"].loaded_filament}...'
			{% set temp = printer["rmmu RMMU_T0"].loaded_filament_temp %}
		{% else %}
			{ action_raise_error("Can not unload unknown Filament! Please select correct toolhead!") }
		{% endif %}
	{% endif %}

	# config
	{% set color_unknown = printer["gcode_macro RatOS"].status_color_unknown|string %}

	DEBUG_ECHO PREFIX="_DEFAULT_UNLOAD_FILAMENT" MSG="temp={temp}"

	# visual feedback
	_LED_UNLOADING_FILAMENT TOOLHEAD=0

	# save gcode state
	SAVE_GCODE_STATE NAME=unload_state

	# heating extruder
	{% if printer.extruder.temperature|int < temp or printer.extruder.can_extrude|lower == 'false' %}
		RATOS_ECHO MSG="Heating extruder to {temp}C... Please wait."
		SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	{% endif %}

	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp}

	# unload filament
	_UNLOAD_FILAMENT TOOLHEAD={toolhead} FILAMENT={toolhead} 

	# restore gcode state
	RESTORE_GCODE_STATE NAME=unload_state

	# update frontend
	SET_GCODE_VARIABLE MACRO=T{toolhead} VARIABLE=color VALUE='"{color_unknown}"'

	# visual feedback
	_LED_FILAMENT_UNLOADED TOOLHEAD=0


[gcode_macro _IDEX_UNLOAD_FILAMENT]
description: Unload filament macro for IDEX printer.
gcode:
	# parameter
	{% set temp = params.TEMP|default(220)|int %}
	{% set toolhead = params.TOOLHEAD|int %}
	{% set filament = params.FILAMENT|default(-1)|int %}

	# config
	{% set color_unknown = printer["gcode_macro RatOS"].status_color_unknown|string %}

	# cache current extruder
	{% set old_extruder = printer.toolhead.extruder %}

	DEBUG_ECHO PREFIX="_IDEX_UNLOAD_FILAMENT" MSG="temp={temp} toolhead={toolhead} old_extruder={old_extruder}, FILAMENT={filament}"

	# visual feedback
	_LED_UNLOADING_FILAMENT TOOLHEAD={toolhead}

	# get target extruder
	{% set target_extruder = 'extruder%s' % ('' if toolhead == 0 else toolhead) %}

	# activate selected extruder
	ACTIVATE_EXTRUDER EXTRUDER={target_extruder}

	# heating extruder
	{% if not printer.pause_resume.is_paused %}
		{% if printer[target_extruder].temperature|int < temp or printer[target_extruder].can_extrude|lower == 'false' %}
			# heating extruder
			RATOS_ECHO MSG="Heating T{toolhead} to {temp}C... Please wait."
			SET_HEATER_TEMPERATURE HEATER={'extruder' if toolhead == 0 else 'extruder1'} TARGET={temp}
		{% endif %}
		TEMPERATURE_WAIT SENSOR={target_extruder} MINIMUM={temp}
	{% endif %}

	# unload filament
	_UNLOAD_FILAMENT TOOLHEAD={toolhead} FILAMENT={filament}

	# reactivate original extruder
	{% if printer.pause_resume.is_paused %}
		ACTIVATE_EXTRUDER EXTRUDER={old_extruder}
	{% endif %}

	# update frontend
	SET_GCODE_VARIABLE MACRO=T{toolhead} VARIABLE=color VALUE='"{color_unknown}"'

	# visual feedback
	_LED_FILAMENT_UNLOADED TOOLHEAD={toolhead}


#####
# UNLOAD FILAMENT MACROS 
#####
[gcode_macro _UNLOAD_FILAMENT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set filament = params.FILAMENT|default(-1)|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_FILAMENT" MSG="toolhead={toolhead}, FILAMENT={filament}"

	# unload filament
	_MOVE_TO_LOADING_POSITION TOOLHEAD={(0 if toolhead == -1 else toolhead)}
	{% if printer["rmmu_hub"] is defined %}
		RMMU_UNLOAD_FILAMENT FILAMENT={filament}
	{% else %}
		_UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE TOOLHEAD={toolhead}
		_UNLOAD_FILAMENT_FROM_COOLING_ZONE_TO_EXTRUDER TOOLHEAD={toolhead}
	{% endif %}
	_CLEANING_MOVE TOOLHEAD={(0 if toolhead == -1 else toolhead)}


[gcode_macro _UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set pause = params.PAUSE|default(3000)|int %}

	# config
	{% set hotend_type = printer["gcode_macro T%s" % toolhead].hotend_type|default("HF")|lower %}
	{% set has_cht_nozzle = true if printer["gcode_macro T%s" % toolhead].has_cht_nozzle|default(false)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE" MSG="toolhead={toolhead} hotend_type={hotend_type} has_cht_nozzle={has_cht_nozzle}"
	RATOS_ECHO MSG="Unloading filament from nozzle to cooling zone... Please wait!"

	_PURGE_BEFORE_UNLOAD TOOLHEAD={toolhead}
	{% if hotend_type == "sf" and has_cht_nozzle %}
		_UNLOAD_SF_CHT TOOLHEAD={toolhead}
	{% elif hotend_type == "sf" and not has_cht_nozzle %}
		_UNLOAD_SF TOOLHEAD={toolhead}
	{% elif hotend_type == "hf" and has_cht_nozzle %}
		_UNLOAD_HF_CHT TOOLHEAD={toolhead}
	{% elif hotend_type == "hf" and not has_cht_nozzle %}
		_UNLOAD_HF TOOLHEAD={toolhead}
	{% elif hotend_type == "uhf" and has_cht_nozzle %}
		_UNLOAD_UHF_CHT TOOLHEAD={toolhead}
	{% elif hotend_type == "uhf" and not has_cht_nozzle %}
		_UNLOAD_UHF TOOLHEAD={toolhead}
	{% endif %}
	G4 P{pause}      # wait for the filament to be solidified


[gcode_macro _UNLOAD_FILAMENT_FROM_COOLING_ZONE_TO_EXTRUDER]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	# config
	{% set extruder_load_speed = printer["gcode_macro T%s" % toolhead].extruder_load_speed|float * 60 %}
	{% set extruder_gear_to_cooling_position_distance = printer["gcode_macro T%s" % toolhead].extruder_gear_to_cooling_position_distance|float %}
	{% set tooolhead_sensor_to_extruder_gear_distance = printer["gcode_macro T%s" % toolhead].tooolhead_sensor_to_extruder_gear_distance|float %}

	DEBUG_ECHO PREFIX="_UNLOAD_FILAMENT_FROM_COOLING_ZONE_TO_EXTRUDER" MSG="toolhead={toolhead} extruder_load_speed={extruder_load_speed} extruder_gear_to_cooling_position_distance={extruder_gear_to_cooling_position_distance} tooolhead_sensor_to_extruder_gear_distance={tooolhead_sensor_to_extruder_gear_distance}"

	# eject filament       
	G0 E-{extruder_gear_to_cooling_position_distance + tooolhead_sensor_to_extruder_gear_distance + 50} F{extruder_load_speed}

	RATOS_ECHO MSG="Filament unloaded! Please inspect the tip of the filament before reloading."


#####
# FILAMENT TIP FORMING
#####
[gcode_macro _UNLOAD_SF]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_SF" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=10


[gcode_macro _UNLOAD_HF]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_HF" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=14


[gcode_macro _UNLOAD_UHF]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_UHF" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=18 COOLING_MOVE_LENGTH=20 DIP=True


[gcode_macro _UNLOAD_SF_CHT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_SF_CHT" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=10


[gcode_macro _UNLOAD_HF_CHT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_HF_CHT" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=14


[gcode_macro _UNLOAD_UHF_CHT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_UNLOAD_UHF_CHT" MSG="toolhead={toolhead}"

	_TIP_FORMING RETRACT_LENGTH=18


[gcode_macro _TIP_FORMING]
gcode:
	# cooling parameter
	{% set cooling_moves = params.COOLING_MOVES|default(4)|int %}
	{% set cooling_move_length = params.COOLING_MOVE_LENGTH|default(10)|float %}
	{% set start_cooling_speed = params.START_COOLING_SPEED|default(10)|float * 60 %}
	{% set end_cooling_speed = params.END_COOLING_SPEED|default(50)|float * 60 %}
	{% if cooling_moves == 0 %}
		{% set cooling_move_length = 0 %}
	{% endif %}

	# dipping parameter
	{% set dip = true if params.DIP|default(false)|lower == "true" else false %}
	{% set dip_length = params.DIP_LENGTH|default(22)|float %}
	{% set dip_speed = params.DIP_SPEED|default(30)|float * 60 %}
	{% set dip_retract_speed = params.DIP_RETRACT_SPEED|default(70)|float * 60 %}

	# retraction parameter
	{% set initial_retract_length = params.INITIAL_RETRACT_LENGTH|default(15)|float %}
	{% set retract_length = params.RETRACT_LENGTH|default(18)|float %}
	{% set start_retract_speed = params.START_RETRACT_SPEED|default(120)|float * 60 %}
	{% set end_retract_speed = params.END_RETRACT_SPEED|default(20)|float * 60 %}

	M220 S100    # reset any speed override

	# retraction
	G92 E0       # Reset extrusion distance
	{% set retract = retract_length + cooling_move_length / 2 - initial_retract_length %}
	G1 E-{initial_retract_length} F{start_retract_speed}
	G1 E-{0.7 * retract} F{1.0 * end_retract_speed}
	G1 E-{0.2 * retract} F{0.5 * end_retract_speed}
	G1 E-{0.1 * retract} F{0.3 * end_retract_speed}

	# cooling
	G92 E0       # Reset extrusion distance
	{% if cooling_moves > 0 %}
		{% set i = (end_cooling_speed - start_cooling_speed) / (2 * cooling_moves - 1) %}
		{% for m in range(cooling_moves) %}
			G1 E{cooling_move_length} F{(start_cooling_speed + i * m * 2)}
			G1 E-{cooling_move_length} F{(start_cooling_speed + i * (m * 2 + 1))}
		{% endfor %}
	{% endif %}

	# dipping 
	G92 E0       # Reset extrusion distance
	{% if dip %}
		G1 E{dip_length} F{dip_speed}
		G4 P100
		G1 E-{dip_length} F{dip_retract_speed}
	{% endif %}

	G92 E0      # Reset extrusion distance
	M400        # Wait for moves to finish


#####
# UNLOAD FILAMENT EVENTS 
#####
[gcode_macro _ON_TOOLHEAD_FILAMENT_SENSOR_RUNOUT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	{% if printer["rmmu_hub"] is not defined %}
		DEBUG_ECHO PREFIX="_ON_TOOLHEAD_FILAMENT_SENSOR_RUNOUT" MSG="toolhead={toolhead}"
		_ON_FILAMENT_END TOOLHEAD={toolhead} CLOGGED=false
	{% endif %}


[gcode_macro _ON_TOOLHEAD_FILAMENT_SENSOR_CLOG]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_ON_TOOLHEAD_FILAMENT_SENSOR_CLOG" MSG="toolhead={toolhead}"
	_ON_FILAMENT_END TOOLHEAD={toolhead} CLOGGED=true


[gcode_macro _ON_FEEDER_FILAMENT_SENSOR_RUNOUT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	DEBUG_ECHO PREFIX="_ON_FEEDER_FILAMENT_SENSOR_RUNOUT" MSG="toolhead={toolhead}"
	_ON_FILAMENT_END TOOLHEAD={toolhead} CLOGGED=false


[gcode_macro _ON_FEEDER_FILAMENT_SENSOR_CLOG]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	{% if printer["rmmu_hub"] is not defined %}
		DEBUG_ECHO PREFIX="_ON_FEEDER_FILAMENT_SENSOR_CLOG" MSG="toolhead={toolhead}"
		_ON_FILAMENT_END TOOLHEAD={toolhead} CLOGGED=true
	{% endif %}


[gcode_macro _ON_FILAMENT_END]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set clogged = true if params.CLOGGED|default(false)|lower == 'true' else false %}

	# Config
	{% set unload_after_runout = printer["gcode_macro T%s" % toolhead].unload_after_runout|float %}

	# visual feedback
	{% if clogged %}
		_LED_FILAMENT_CLOG TOOLHEAD={toolhead}
	{% else %}
		_LED_FILAMENT_RUNOUT TOOLHEAD={toolhead}
	{% endif %}

	DEBUG_ECHO PREFIX="_ON_FILAMENT_END" MSG="toolhead={toolhead}"

	{% if printer.virtual_sdcard.is_active %}
		{% if not printer.pause_resume.is_paused %}
			PAUSE
		{% endif %}
		{% if printer["rmmu_hub"] is defined %}
			RMMU_FILAMENT_RUNOUT TOOLHEAD={toolhead} CLOGGED={clogged}
		{% else %}
			{% if not clogged and unload_after_runout %}
				UNLOAD_FILAMENT TOOLHEAD={toolhead}
			{% endif %}
		{% endif %}
		{% if not clogged and printer["dual_carriage"] is defined and printer["rmmu_hub"] is not defined %}
			{% if printer["gcode_macro _IDEX_JOIN_SPOOLS"].enabled|default(false)|lower == 'true'%}
				_JOIN_SPOOL TOOLHEAD={toolhead}
			{% endif %}
		{% endif %}
	{% endif %}


#####
# UNLOAD FILAMENT EXTRAS
#####
[gcode_macro M600]
description: Executes a color change by pausing the printer an unloading the filament.
gcode:
	PAUSE
	UNLOAD_FILAMENT
	RATOS_ECHO MSG="Please load new filament and resume"
