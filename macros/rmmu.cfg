[gcode_macro RatOS]
variable_toolchange_zhop: 2.0                   # toolchange z-hop
variable_toolchange_zspeed: 25                  # toolchange z-hop and drop z-speed
variable_toolchange_sync_fans: False            # force part fan synchronization in single toolhead mode
variable_toolchange_combined_zhop: False        # combines Z and E moves for z-hops and drops
variable_toolchange_travel_speed: 300           # parking travel speed 
variable_toolchange_travel_accel: 5000          # parking travel accel 
variable_toolchange_extrusion: 2.0              # toolchange extrusion
variable_toolchange_retraction: 2.0             # toolchange retraction 
variable_toolchange_feedrate: 7200              # toolchange extrusion and retraction feed rate
variable_toolchange_prepurging_timer: 0         # dynamic mode, switches between fast toolshifts and standy mode if last toolshift is more than X seconds old
variable_toolchange_standby_temp: -1            # standby temperature for toolshifts
variable_toolchange_purge: 25                   # prepurge and wakeup purging amount
variable_toolchange_first_purge: 50             # amount of filament to purge for the first usage of a toolhead
variable_toolchange_first_purge_feedrate: 300   # NEW! first purge feedrate

[ratos]
enable_post_processing: True

[rmmu_hub]

#####
# TOOLHEAD SELECTION
####
[gcode_macro TOOL]
gcode:
	{% set t = params.T|default(0)|int %}
	{% set x = params.X|default(-1.0)|float %}
	{% set y = params.Y|default(-1.0)|float %}
	{% set z = params.Z|default(0.0)|float %}
	{% set s = params.S|default(1)|int %}

	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}
	{% if is_printing_gcode %}

		# next toolhead position
		{% set pos = printer.toolhead.position %}
		SET_GCODE_VARIABLE MACRO=_RMMU_ON_FILAMENT_HAS_CHANGED VARIABLE=x VALUE={x}
		SET_GCODE_VARIABLE MACRO=_RMMU_ON_FILAMENT_HAS_CHANGED VARIABLE=y VALUE={y}
		SET_GCODE_VARIABLE MACRO=_RMMU_ON_FILAMENT_HAS_CHANGED VARIABLE=z VALUE={pos.z}

		# change filament
		RMMU_CHANGE_FILAMENT FILAMENT={t} X={x} Y={y}

	{% else %}

		# load/unload filaments when clicking Tx buttons
		{% set svv = printer.save_variables.variables %}
		{% set toolhead = svv.rmmu_t0_loaded_filament %}
		{% set temp = svv.rmmu_t0_loaded_filament %}
		{% if printer["rmmu RMMU_T0"].toolhead_filament_sensor["filament_present"]|lower == "true" and toolhead != -1 %}
			{% if toolhead != t %}
				TX_LOAD_PROMPT TOOLHEAD={t} UNLOAD=True
			{% else %}
				TX_UNLOAD_PROMPT TOOLHEAD={t}
			{% endif %}
		{% else %}
			TX_LOAD_PROMPT TOOLHEAD={t}
		{% endif %}

	{% endif %}
	

[gcode_macro TX_LOAD_PROMPT]
gcode:
	{% set t = params.TOOLHEAD|default(0)|int %}
	{% set unload = True if params.UNLOAD|default(False)|lower == "true" else False %}

	RESPOND TYPE=command MSG="action:prompt_begin Load Filament T{t}"
	RESPOND TYPE=command MSG="action:prompt_button PLA...............220°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=220 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button PETG..............250°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=250 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button ABS...............255°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=255 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button ASA...............260°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=260 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button PC................275°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=275 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button NYLON.............290°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=290 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_button FLEX..............240°C|TX_LOAD_ACTION TOOLHEAD={t} TEMP=240 UNLOAD={unload}"
	RESPOND TYPE=command MSG="action:prompt_show"
	

[gcode_macro TX_LOAD_ACTION]
gcode:
	{% set t = params.TOOLHEAD|default(0)|int %}
	{% set temp = params.TEMP|default(0)|int %}
	{% set unload = True if params.UNLOAD|default(False)|lower == "true" else False %}

	RESPOND TYPE=command MSG="action:prompt_end"

	{% if unload %}
		UNLOAD_FILAMENT 
	{% endif %}
	LOAD_FILAMENT TOOLHEAD={t} TEMP={temp}


[gcode_macro TX_UNLOAD_PROMPT]
gcode:
	{% set t = params.TOOLHEAD|default(0)|int %}

    RESPOND TYPE=command MSG="action:prompt_begin Unload Filament T{t}"
    RESPOND TYPE=command MSG="action:prompt_text Do you want to unload the filament?"
    RESPOND TYPE=command MSG="action:prompt_footer_button YES|TX_UNLOAD_ACTION"
    RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end|error"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro TX_UNLOAD_ACTION]
gcode:
	RESPOND TYPE=command MSG="action:prompt_end"

	UNLOAD_FILAMENT 


#####
# RMMU UNLOAD MACROS
#####
[gcode_macro _RMMU_UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set pause = params.PAUSE|default(3000)|int %}
	{% set copy_mirror = True if params.COPY_MIRROR|default('false')|lower == 'true' else False %}

	# get current printing mode
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_RMMU_UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE" MSG="TOOLHEAD: {toolhead}, IS_PRINTING_GCODE: {is_printing_gcode}"

	{% if is_printing_gcode and "xyz" in printer.toolhead.homed_axes %}

		# config
		{% set purge_before_unload = printer["gcode_macro T%s" % toolhead].purge_before_unload|float %}

		# cache current speed
		SET_GCODE_VARIABLE MACRO=_RMMU_ON_FILAMENT_HAS_CHANGED VARIABLE=fan_speed VALUE={printer["fan"].speed|float}

		# turn fan off
		M106 S0

		# move to loading position
		{% if not copy_mirror %}
			_MOVE_TO_LOADING_POSITION TOOLHEAD={toolhead}
		{% endif %}

		# purge
		{% if purge_before_unload > 0 %}
			_PURGE_BEFORE_UNLOAD TOOLHEAD={toolhead}
		{% else %}
			# wait a bit for the filament to melt in case it was a short move
			G4 P3000
		{% endif %}

	{% endif %}

	# unload filament
	_UNLOAD_FILAMENT_FROM_NOZZLE_TO_COOLING_ZONE TOOLHEAD={toolhead} PAUSE={pause}

	# wait for moves to finish
	M400


#####
# UI EXPOSED FILAMENT MACROS
#####
[gcode_macro HOME_FILAMENT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}

	DEBUG_ECHO PREFIX="HOME_FILAMENT" MSG="TOOLHEAD: {toolhead}"

	{% if printer["rmmu_hub"] is defined %}
		{% if toolhead >= -1 and toolhead < printer["rmmu_hub"].total_tool_count %}
			RMMU_HOME_FILAMENT TOOLHEAD={toolhead}
		{% else %}
			RATOS_ECHO MSG="Please select correct toolhead!"
		{% endif %}
	{% endif %}


[gcode_macro MOVE_FILAMENT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}
	{% set move = params.MOVE|default(50)|int %}
	{% set speed = params.SPEED|default(10)|int %}
	{% set accel = params.ACCEL|default(100)|int %}
	{% set sync = params.SYNC_EXTRUDER|default(0)|int %}

	DEBUG_ECHO PREFIX="MOVE_FILAMENT" MSG="TOOLHEAD: {toolhead}, MOVE: {move}, SPEED: {speed}, SYNC: {sync}"

	{% if printer["rmmu_hub"] is defined %}
		{% if toolhead >= 0 and toolhead < printer["rmmu_hub"].total_tool_count %}
			{% if sync == 1 and not printer[printer.toolhead.extruder].can_extrude %}
				RATOS_ECHO MSG="Hotend to cold for synced moves!"
			{% else %}
				RMMU_MOVE_FILAMENT { rawparams }
			{% endif %}
		{% else %}
			RATOS_ECHO MSG="Please select correct toolhead!"
		{% endif %}
	{% endif %}


[gcode_macro EJECT_FILAMENT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}

	DEBUG_ECHO PREFIX="EJECT_FILAMENT" MSG="TOOLHEAD: {toolhead}"

	{% if printer["rmmu_hub"] is defined %}
		{% if toolhead >= -1 and toolhead < printer["rmmu_hub"].total_tool_count %}
			RMMU_EJECT_FILAMENT TOOLHEAD={toolhead}
		{% else %}
			RATOS_ECHO MSG="Please select correct toolhead!"
		{% endif %}
	{% endif %}


[gcode_macro JOIN_SPOOLS]
gcode:
	# parameter
	{% set spools = params.SPOOLS|default("") %}

	DEBUG_ECHO PREFIX="JOIN_SPOOLS" MSG="SPOOLS: {spools}"

	{% if printer["rmmu"] is defined %}
		RMMU_JOIN_SPOOLS SPOOLS={spools}
	{% endif %}


[gcode_macro REMAP_TOOLHEADS]
gcode:
	# parameter
	{% set toolheads = params.TOOLHEADS|default("") %}

	DEBUG_ECHO PREFIX="REMAP_TOOLHEADS" MSG="TOOLHEADS: {toolheads}"

	{% if printer["rmmu"] is defined %}
		RMMU_REMAP_TOOLHEADS TOOLHEADS={toolheads}
	{% endif %}


#####
# RMMU HOOKS
#####
[gcode_macro _RMMU_BEFORE_FILAMENT_CHANGE]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set x = params.X|float %}                           # next x coordinate after toolchange
	{% set y = params.Y|float %}                           # next y coordinate after toolchange
	{% set wipe_accel = params.WIPE_ACCEL|int %}           # slicer profile wipe tower accel
	{% set copy_mirror = True if params.COPY_MIRROR|default('false')|lower == 'true' else False %}

	# config
	{% set has_oozeguard = True if printer["gcode_macro T%s" % toolhead].has_oozeguard|default('false')|lower == 'true' else False %}
	{% set loading_position = printer["gcode_macro T%s" % toolhead].loading_position|float %}
	{% set speed = printer["gcode_macro RatOS"].toolchange_travel_speed * 60 %}
	{% set accel = printer["gcode_macro RatOS"].toolchange_travel_accel %}
	{% set loading_position_t0 = printer["gcode_macro T0"].loading_position|float %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set center_x = printable_x_max / 2 %}

	# cache current acceleration
	{% set max_accel = printer.toolhead.max_accel %}

	DEBUG_ECHO PREFIX="_RMMU_BEFORE_FILAMENT_CHANGE" MSG="TOOLHEAD: {toolhead}, X: {x}, Y: {y}, SPEED: {speed}, ACCEL: {accel}, WIPE_ACCEL: {wipe_accel}"

	# move to parking position
	M204 S{accel}                                                       # set travel acceleration                
	G92 E0                                                              # reset extrusion distance
	{% if not copy_mirror %}
		G0 E-3 F3600                                                    # retract filament
		{% if has_oozeguard %}
			G0 X{loading_position} Y{y} F{speed}                        # move to wipe tower y position and park toolhead
		{% endif %}
	{% else %}
		# G1 X{center_x} F{speed}                                       # move to x center
		# _IDEX_MIRROR DANCE=0                                          # switch to mirror mode
		# G1 X{(center_x - (center_x + loading_position_t0))} F{speed}  # move both toolheads to the loading positions
	{% endif %}
	G92 E0                                                              # reset extrusion distance
	M400                                                                # wait for moves to finish
	{% if wipe_accel > 0 %}
		M204 S{wipe_accel}                                              # set wipe tower acceleration                
	{% else %}
		M204 S{max_accel}                                               # set max_accel                
	{% endif %}


[gcode_macro _RMMU_BEFORE_FILAMENT_RUNOUT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set clogged = true if params.CLOGGED|default(true)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_RMMU_BEFORE_FILAMENT_RUNOUT" MSG="TOOLHEAD: {toolhead}, CLOGGED: {clogged}"

	# move to loading position
	_MOVE_TO_LOADING_POSITION TOOLHEAD={toolhead}

	# give the filament some time to melt before doing the tip forming
	G4 P2000


[gcode_macro _RMMU_AFTER_FILAMENT_INSERT]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}

	# config
	{% set purge_after_load = printer["gcode_macro T%s" % toolhead].purge_after_load|float %}
	{% set purge_feedrate = printer["gcode_macro T%s" % toolhead].purge_feedrate|float %}

	DEBUG_ECHO PREFIX="_RMMU_AFTER_FILAMENT_INSERT" MSG="TOOLHEAD: {toolhead}"

	# purge filament
	_PURGE_FILAMENT TOOLHEAD=0 E={purge_after_load} R=2 F={purge_feedrate}

	# retract a bit
	G92 E0                                 # Reset extrusion distance
	G0 E-2 F2100                           # retract
	M400                                   # Wait for move to complete

	# cleaning move
	_CLEANING_MOVE TOOLHEAD={toolhead}

	# visual feedback
	_LED_PRINTING

	# resume print
	RESUME


#####
# RMMU EVENTS
#####
[gcode_macro _RMMU_ON_FILAMENT_HAS_CHANGED]
variable_x: 0
variable_y: 0
variable_z: 0
variable_fan_speed: 0
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|int %}
	{% set copy_mirror = True if params.COPY_MIRROR|default('false')|lower == 'true' else False %}

	# config
	{% set has_oozeguard = True if printer["gcode_macro T%s" % toolhead].has_oozeguard|default('false')|lower == 'true' else False %}

	# get current printing mode
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_RMMU_ON_FILAMENT_HAS_CHANGED" MSG="TOOLHEAD: {toolhead}, IS_PRINTING_GCODE: {is_printing_gcode}"

	{% if is_printing_gcode and "xyz" in printer.toolhead.homed_axes %}

		# config
		{% set purge_after_load = printer["gcode_macro T%s" % toolhead].purge_after_load|float %}
		{% set purge_feedrate = printer["gcode_macro T%s" % toolhead].purge_feedrate|float %}
		{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}

		# Handle toolhead settings
		CACHE_TOOLHEAD_SETTINGS
		SET_MACRO_TRAVEL_SETTINGS

		{% if has_oozeguard %}
			# purge filament
			G92 E0                                 # Reset extrusion distance
			_PURGE_FILAMENT TOOLHEAD={toolhead} E={purge_after_load} R=2 F={purge_feedrate}

			# retract a bit
			G92 E0                                 # Reset extrusion distance
			G0 E-2 F2100                           # retract
			M400                                   # Wait for move to complete

			# cleaning move
			_CLEANING_MOVE TOOLHEAD={toolhead}
		{% endif %}

		# turn fan back on
		M106 S{(255 * fan_speed)}

		# reset fan speed cache
		SET_GCODE_VARIABLE MACRO=_RMMU_ON_FILAMENT_HAS_CHANGED VARIABLE=fan_speed VALUE=0

		{% if not copy_mirror %}
			# move back to printing position
			G1 X{x} Y{y} Z{z} F{speed}
			# extrude a bit
			G92 E0                                 # Reset extrusion distance
			G0 E2 F2100                           # retract
			G92 E0                                 # Reset extrusion distance
		{% endif %}

		# Handle toolhead settings
		RESTORE_TOOLHEAD_SETTINGS

		# visual feedback
		_LED_PRINTING

	{% endif %}


[gcode_macro _RMMU_ON_FILAMENT_LOADING_ERROR]
gcode:
	# parameter
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}

	# get current printing mode
	{% set is_printing_gcode = true if printer["gcode_macro START_PRINT"].is_printing_gcode|default(true)|lower == 'true' else false %}

	DEBUG_ECHO PREFIX="_RMMU_ON_FILAMENT_LOADING_ERROR" MSG="TOOLHEAD: {toolhead}, IS_PRINTING_GCODE: {is_printing_gcode}"

	# visual feedback
	_LED_ERROR	

	{% if is_printing_gcode and "xyz" in printer.toolhead.homed_axes %}
		CONSOLE_ECHO TITLE="Toolhead T{toolhead} error!" TYPE="alert" MSG="Please load filament T{toolhead} and resume the print!"
		SAVE_GCODE_STATE NAME=PAUSE_state
		{printer.configfile.settings['gcode_macro pause'].rename_existing}
	{% else %}
		{ action_raise_error("Toolhead T%s error!" % toolhead)}
	{% endif %}


#####
# PURGE TOWER SPEED CONFIG
#####
[gcode_macro PURGE_TOWER_CONFIG]
variable_wipe_speed: 300
variable_bridging_speed: 75
variable_empty_grid_speed: 300
variable_wipe_accel: 15000
variable_bridging_accel: 2500
variable_empty_grid_accel: 15000
gcode:
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=empty_grid_speed VALUE={params.GRID_SPEED|default(300)|int}
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=wipe_speed VALUE={params.WIPE_SPEED|default(300)|int}
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=bridging_speed VALUE={params.BRIDGE_SPEED|default(75)|int}
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=empty_grid_accel VALUE={params.GRID_ACCEL|default(15000)|int}
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=wipe_accel VALUE={params.WIPE_ACCEL|default(15000)|int}
	SET_GCODE_VARIABLE MACRO=PURGE_TOWER_CONFIG VARIABLE=bridging_accel VALUE={params.BRIDGE_ACCEL|default(2500)|int}


[gcode_macro _ON_EMPTY_GRID_START]
variable_last_empty_grid_min_x: 0
variable_last_empty_grid_max_x: 0
variable_last_empty_grid_min_y: 0
variable_last_empty_grid_max_y: 0
variable_last_empty_grid_layer_number: 0
variable_last_speed_factor: 100
variable_last_accel: 5000
gcode:
	# config
	{% set empty_grid_accel = printer["gcode_macro PURGE_TOWER_CONFIG"].empty_grid_accel|default(5000)|int %}
	{% set empty_grid_speed = printer["gcode_macro PURGE_TOWER_CONFIG"].empty_grid_speed|default(100)|int * 60 %}

	# get current layer number
	{% set layer_number = printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|default(0)|int %}

	# cache current layer number
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_empty_grid_layer_number VALUE={layer_number}

	# cache current accel
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_accel VALUE={printer.toolhead.max_accel|float}

	# set empty grid speed and accel
	{% if layer_number > 1 %}
		M220 S100
		G1 F{empty_grid_speed}
		SET_VELOCITY_LIMIT ACCEL={empty_grid_accel} MINIMUM_CRUISE_RATIO=0.5 SQUARE_CORNER_VELOCITY=5
	{% endif %}


[gcode_macro _ON_EMPTY_GRID_END]
gcode:
	# parameter
	{% set min_x = params.MIN_X|default(0)|float %}
	{% set max_x = params.MAX_X|default(0)|float %}
	{% set min_y = params.MIN_Y|default(0)|float %}
	{% set max_y = params.MAX_Y|default(0)|float %}

	# cache empty grid area
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_empty_grid_min_x VALUE={min_x}
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_empty_grid_max_x VALUE={max_x}
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_empty_grid_min_y VALUE={min_y}
	SET_GCODE_VARIABLE MACRO=_ON_EMPTY_GRID_START VARIABLE=last_empty_grid_max_y VALUE={max_y}

	# config
	{% set last_accel = printer["gcode_macro _ON_EMPTY_GRID_START"].last_accel|default(5000)|float %}

	# get layer numbers
	{% set layer_number = printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|default(0)|int %}

	# restore previous accel
	{% if layer_number > 1 %}
		SET_VELOCITY_LIMIT ACCEL={last_accel} MINIMUM_CRUISE_RATIO=0.5 SQUARE_CORNER_VELOCITY=5
	{% endif %}


[gcode_macro _ON_CP_TOOLCHANGE_WIPE]
variable_last_accel: 5000
gcode:
	# parameter
	{% set wipe_min_x = params.MIN_X|default(0)|float + 1 %}
	{% set wipe_max_x = params.MAX_X|default(0)|float - 1 %}
	{% set wipe_min_y = params.MIN_Y|default(0)|float + 1 %}
	{% set wipe_max_y = params.MAX_Y|default(0)|float - 1 %}

	# config
	{% set wipe_accel = printer["gcode_macro PURGE_TOWER_CONFIG"].wipe_accel|default(5000)|int %}
	{% set bridging_accel = printer["gcode_macro PURGE_TOWER_CONFIG"].bridging_accel|default(2000)|int %}
	{% set wipe_speed = printer["gcode_macro PURGE_TOWER_CONFIG"].wipe_speed|default(100)|int * 60 %}
	{% set bridging_speed = printer["gcode_macro PURGE_TOWER_CONFIG"].bridging_speed|default(100)|int * 60 %}

	# get layer numbers
	{% set layer_number = printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|default(0)|int %}
	{% set last_empty_grid_layer_number = printer["gcode_macro _ON_EMPTY_GRID_START"].last_empty_grid_layer_number|default(0)|int %}

	# get empty grid area
	{% set empty_grid_min_x = printer["gcode_macro _ON_EMPTY_GRID_START"].last_empty_grid_min_x|default(0)|float + 1 %}
	{% set empty_grid_max_x = printer["gcode_macro _ON_EMPTY_GRID_START"].last_empty_grid_max_x|default(0)|float - 1 %}
	{% set empty_grid_min_y = printer["gcode_macro _ON_EMPTY_GRID_START"].last_empty_grid_min_y|default(0)|float + 1 %}
	{% set empty_grid_max_y = printer["gcode_macro _ON_EMPTY_GRID_START"].last_empty_grid_max_y|default(0)|float - 1 %}

	# cache current accel
	SET_GCODE_VARIABLE MACRO=_ON_CP_TOOLCHANGE_WIPE VARIABLE=last_accel VALUE={printer.toolhead.max_accel|float}

	{% if layer_number > 1 %}

		# detect bridging
		{% set is_bridge = False %}
		{% if last_empty_grid_layer_number == layer_number - 1 %}
			{% if wipe_max_x >= empty_grid_min_x and wipe_min_x <= empty_grid_max_x %}
				{% if wipe_max_y >= empty_grid_min_y and wipe_min_y <= empty_grid_max_y %}
					{% set is_bridge = True %}
				{% endif %}
			{% endif %}
		{% endif %}

		# set purge tower bridging speed factor
		{% if is_bridge %}
			M220 S100
			G1 F{bridging_speed}
			SET_VELOCITY_LIMIT ACCEL={bridging_accel} MINIMUM_CRUISE_RATIO=0.5 SQUARE_CORNER_VELOCITY=5
		{% else %}
			M220 S100
			G1 F{wipe_speed}
			SET_VELOCITY_LIMIT ACCEL={wipe_accel} MINIMUM_CRUISE_RATIO=0.5 SQUARE_CORNER_VELOCITY=5
		{% endif %}

	{% endif %}


[gcode_macro _ON_CP_TOOLCHANGE_END]
gcode:
	# config
	{% set last_accel = printer["gcode_macro _ON_CP_TOOLCHANGE_WIPE"].last_accel|default(5000)|float %}

	# get layer numbers
	{% set layer_number = printer["gcode_macro _ON_LAYER_CHANGE"].layer_number|default(0)|int %}

	# restore previous accel
	{% if layer_number > 1 %}
		SET_VELOCITY_LIMIT ACCEL={last_accel} MINIMUM_CRUISE_RATIO=0.5 SQUARE_CORNER_VELOCITY=5
	{% endif %}


#####
# OVERRIDES
#####
# do not call M104 from within RatOS macros
# use SET_HEATER_TEMPERATURE instead 
[gcode_macro M104]
rename_existing: M104.1
gcode:
	# parameter
	{% set s = params.S|default(0)|int %}
	{% set t = params.T|default(-1)|int %}

	{% if t == -1 %}
		M104.1 S{s}

	{% else %}
		# get physical toolhead
		{% if printer["rmmu_hub"] is defined %}
			{% set t = printer["rmmu_hub"].mapping["%s" % t]["TOOLHEAD"]|int %}
		{% endif %}

		# set temperature offset
		{% if printer["gcode_macro T%s" % t] is defined %}
			{% set temperature_offset = printer["gcode_macro T%s" % t].temperature_offset|default(0)|int %}
			{% set s = [s + temperature_offset, 0]|max %}
			{% if temperature_offset != 0 %}
				RATOS_ECHO PREFIX="M104" MSG="Temperatur offset of {temperature_offset}°C added to toolhead T{t}."
			{% endif %}
		{% endif %}

		# handle idex toolhead standby
		{% set is_in_standby = false %}
		{% if printer["dual_carriage"] is defined %}
			{% set toolchange_standby_temp = printer["gcode_macro RatOS"].toolchange_standby_temp|default(-1)|float %}
			{% if toolchange_standby_temp > -1 %}
				{% set is_in_standby = true if printer["gcode_macro T%s" % t].standby|default(false)|lower == 'true' else false %}
			{% endif %}
		{% endif %}

		# call klipper base function
		{% if not is_in_standby %}
			M104.1 S{s} T{t}
		{% endif %}

	{% endif %}


# do not call M109 from within RatOS macros
# use TEMPERATURE_WAIT instead 
[gcode_macro M109]
rename_existing: M109.1
gcode:
	# parameter
	{% set s = params.S|default(0)|int %}
	{% set t = params.T|default(-1)|int %}

	{% if t == -1 %}
		M109.1 S{s}

	{% else %}
		# get physical toolhead
		{% if printer["rmmu_hub"] is defined %}
			{% set t = printer["rmmu_hub"].mapping["%s" % t]["TOOLHEAD"]|int %}
		{% endif %}

		# set temperature offset
		{% if printer["gcode_macro T%s" % t] is defined %}
			{% set temperature_offset = printer["gcode_macro T%s" % t].temperature_offset|default(0)|int %}
			{% set s = [s + temperature_offset, 0]|max %}
			{% if temperature_offset != 0 %}
				RATOS_ECHO PREFIX="M109" MSG="Temperatur offset of {temperature_offset}°C added to toolhead T{t}."
			{% endif %}
		{% endif %}

		# handle idex toolhead standby
		{% set is_in_standby = false %}
		{% if printer["dual_carriage"] is defined %}
			{% set toolchange_standby_temp = printer["gcode_macro RatOS"].toolchange_standby_temp|default(-1)|float %}
			{% if toolchange_standby_temp > -1 %}
				{% set is_in_standby = true if printer["gcode_macro T%s" % t].standby|default(false)|lower == 'true' else false %}
			{% endif %}
		{% endif %}

		# call klipper base function
		{% if not is_in_standby %}
			M109.1 S{s} T{t}
		{% endif %}

	{% endif %}


[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: SET_HEATER_TEMPERATURE_BASE
gcode:
	# parameter
	{% set heater = params.HEATER|default("") %}
	{% set target = params.TARGET|default(0)|int %}

	{% if heater|lower == "extruder" or heater|lower == "extruder1" %}
		# get physical toolhead
		{% set t = 0 if heater|lower == "extruder" else 1 %}

		# set temperature offset
		{% if printer["gcode_macro T%s" % t] is defined and target > 0 %}
			{% set temperature_offset = printer["gcode_macro T%s" % t].temperature_offset|default(0)|int %}
			{% set target = [target + temperature_offset, 0]|max %}
			{% if temperature_offset != 0 %}
				RATOS_ECHO PREFIX="SET_HEATER_TEMPERATURE" MSG="Temperatur offset of {temperature_offset}°C added to toolhead T{t}."
			{% endif %}
		{% endif %}

	{% endif %}

	# call klipper base function
	SET_HEATER_TEMPERATURE_BASE HEATER={heater} TARGET={target}


[gcode_macro TEMPERATURE_WAIT]
rename_existing: TEMPERATURE_WAIT_BASE
gcode:
	# parameter
	{% set sensor = params.SENSOR|default("") %}
	{% set minimum = params.MINIMUM|default(-1)|int %}
	{% set maximum = params.MAXIMUM|default(-1)|int %}

	{% if sensor|lower == "extruder" or sensor|lower == "extruder1" %}
		# get physical toolhead
		{% set t = 0 if sensor|lower == "extruder" else 1 %}

		# set temperature offset
		{% if printer["gcode_macro T%s" % t] is defined and (minimum > 0 or maximum > 0) %}
			{% set temperature_offset = printer["gcode_macro T%s" % t].temperature_offset|default(0)|int %}
			{% if minimum > -1 %}
				{% set minimum = [minimum + temperature_offset, 0]|max %}
			{% endif %}
			{% if maximum > -1 %}
				{% set maximum = [maximum + temperature_offset, 0]|max %}
			{% endif %}
			{% if temperature_offset != 0 %}
				RATOS_ECHO PREFIX="TEMPERATURE_WAIT" MSG="Temperatur offset of {temperature_offset}°C added to toolhead T{t}."
			{% endif %}
		{% endif %}

	{% endif %}

	# call klipper base function
	{% if minimum > -1 and maximum > -1 %}
		TEMPERATURE_WAIT_BASE SENSOR="{sensor}" MINIMUM={minimum} MAXIMUM={maximum}
	{% elif minimum > -1 and maximum == -1 %}
		TEMPERATURE_WAIT_BASE SENSOR="{sensor}" MINIMUM={minimum}
	{% elif minimum == -1 and maximum > -1 %}
		TEMPERATURE_WAIT_BASE SENSOR="{sensor}" MAXIMUM={maximum}
	{% endif %}


[gcode_macro SDCARD_PRINT_FILE]
rename_existing: SDCARD_PRINT_FILE_BASE
gcode:
	{% if printer["ratos"] is defined %}
		PROCESS_GCODE_FILE { rawparams }
	{% else %}
		SDCARD_PRINT_FILE_BASE { rawparams }
	{% endif %}
